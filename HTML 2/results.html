<!DOCTYPE html>
<html>

<head>
    <header>
        results of your search
    </header>
    <style>

    </style>
</head>
</html>

<style>
    header{
        margin-left: 40vw; 
        margin-top: 5vw;
    }

    div.content{
        margin-left: 20vw; 
        margin-top: 10vw;
    }

    div.button{
        margin-left: 20vw; 
        margin-top: 10vw;
    }

</style>

<body>
    <div id="content" class="content"></div>
    <div id="button content" class="button">
        <button class="edit" ; id="edit"> Edit </button>
        <form id="editForm" style="display: none;">
            <label for="date">Enter wanted date:</label>
            <input type="date" id="date" name="date" required autocomplete="date">
            <button id="confirm">Confirm</button>
        </form>
        <button class="delete" ; id="delete"> Delete </button>
    </div>
    <script>
        function display_results() {
            //get data from the session storage                                            
            var results = sessionStorage.getItem("results");
            if (results !== "[]") {
                //set the content to search results
                document.getElementById("content").textContent = results;
            }
            else {
                //set the content to search results
                document.getElementById("content").textContent = "no results found";
                //return it on screen 
            }
        }
        function getData(){//from data base
            reservationData = document.getElementById("content").textContent;
            console.log(reservationData);
            parcedData = JSON.parse(reservationData);
            console.log(parcedData);
            console.log(typeof parcedData);
            fullText = parcedData[0]; 
            console.log(fullText);
            emailMatch = fullText.match(/hotelEmail:\s*([^\s,]+)/);
            console.log(emailMatch);
            hotelEmail = emailMatch[1];
            console.log(hotelEmail);
            emailMatch1 = fullText.match(/customerEmail:\s*([^\s,]+)/);
            customerEmail = emailMatch1[1];
            console.log(customerEmail);
            emailMatch2 = fullText.match(/hotel:\s*([^,]+)/);
            hotelName = emailMatch2[1];
            console.log(hotelName);
            return {hotelEmail,customerEmail,hotelName};
        }

        function edit(){
            document.getElementById("editForm").style.display = "block";
            document.getElementById("edit").style.display = "none";
            document.getElementById("delete").style.display = "none";
        }

        async function confirm(event){
            const {hotelEmail,customerEmail,hotelName} = getData();
            event.preventDefault();
            date = document.getElementById("date").value; 
            if (!date){
                console.error("date is invalid",error);
                return;
            }
            try{
                // fetch api link
                response = await fetch(`https://lhoeea8hkl.execute-api.us-east-1.amazonaws.com/prod/send-edit-to-hotel`,
                {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json", // Tell API Gateway that we are sending form data
                    },
                    body: JSON.stringify({
                    "toEmails": [hotelEmail.trim()],
                    "subject" : "edit request",
                    "message" : `customer with email ${customerEmail} would like to change the reservation to ${date}, please decline: https://lhoeea8hkl.execute-api.us-east-1.amazonaws.com/prod/decline-to-customer?email=${customerEmail}&hotel=${encodeURIComponent(hotelName)} or ACCEPT: https://lhoeea8hkl.execute-api.us-east-1.amazonaws.com/accept-to-customer?email=${customerEmail}&hotel=${encodeURIComponent(hotelName)}`
                    })
                }
            );
            data = await response.text();
            console.log("response is:",data);
            alert("email has been sent");        
            }
            catch (error){
                console.error("an error occured:", error);
                alert("an error occured")
            }

        }

        async function cancel(){
            //delete database 
            //send ses to hotel 
            const {hotelEmail,customerEmail} = getData();
            try {
                response = await fetch(
                `https://lhoeea8hkl.execute-api.us-east-1.amazonaws.com/prod/cancel-to-hotel`,
                {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json", // Tell API Gateway that we are sending form data
                    },
                    body: JSON.stringify({
                    "toEmails": [hotelEmail.trim()],
                    "subject" : "cancelation decision",
                    "message" : `customer with email ${customerEmail} would like to delete the reservation`
                    })
                }
                );
                data = await response.text();
                console.log("Server Response:", data);
                alert("Email Sent Successfully! Check your inbox.");
            } catch (error) {
                // If something goes wrong, log the error in the console
                console.error("Error sending email:", error);

                // Show an alert to tell the user that sending the email failed
                alert("Failed to send email. Please check the console for details.");
  }
        }

        document.addEventListener("DOMContentLoaded", display_results);
        document.getElementById("edit").addEventListener("click",edit);
        document.getElementById("delete").addEventListener("click",cancel);
        document.getElementById("confirm").addEventListener("click",confirm);
    </script>

   

</body>

</html>